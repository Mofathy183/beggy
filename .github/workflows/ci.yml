name: CI - Beggy Backend

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

jobs:
    test:
        name: Run Integration Tests
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:15
                env:
                    POSTGRES_USER: soliman
                    POSTGRES_PASSWORD: psqluseradmin
                    POSTGRES_DB: test_db
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        env:
            DATABASE_URL: postgresql://soliman:psqluseradmin@localhost:5432/test_db?schema=public
            NODE_ENV: test
            SESSION_SECRET: test_session_secret
            BCRYPT_SALT_ROUNDS: 10
            COOKIE_EXPIRES_AT: 15
            COOKIE_REFRESH_EXPIRES_AT: 7
            JWT_SECRET: test_jwt_secret
            JWT_EXPIRES_IN: 1h
            JWT_REFRESH_SECRET: test_refresh_secret
            JWT_REFRESH_EXPIRES_IN: 7d
            AI_API_KEY: test_key
            RESEND_API_KEY: test_key
            CORE_ORIGIN: http://localhost:5173

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Install dependencies
              run: npm ci

            - name: Generate Prisma Client
              run: npx prisma generate

            - name: Run Migrations
              run: npx prisma migrate deploy

            - name: Run Jest Tests
              run: npm test
